<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISM Controls Upload</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>ISM Controls Upload</h1>

        <form id="uploadForm">
            <div class="form-group">
                <label for="jsonFile">Upload JSON File:</label>
                <input type="file" id="jsonFile" name="jsonFile" accept=".json,application/json" required>
                <small class="file-info" id="fileInfo"></small>
            </div>

            <div class="form-group">
                <label for="url">URL:</label>
                <input type="text" id="url" name="url" value="https://docs.aws.amazon.com/config/latest/developerguide/managed-rules-by-aws-config.html" placeholder="https://example.com">
            </div>

            <div class="form-group">
                <label for="email">Email Address (for notifications):</label>
                <input type="email" id="email" name="email" required
                       placeholder="your-email@example.com"
                       pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}">
                <small class="file-info">You'll receive an email when processing completes</small>
            </div>

            <button type="submit" id="submitBtn">Submit</button>
        </form>

        <div id="successMessage" class="success-message hidden">
            <h2 id="successTitle">Success!</h2>
            <p id="successText"></p>
        </div>

        <div id="errorMessage" class="error-message hidden">
            <h2>Error</h2>
            <p id="errorText"></p>
        </div>

        <div id="loadingMessage" class="loading-message hidden">
            <div class="spinner"></div>
            <p id="loadingText">In Progress...</p>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">
                    <span class="progress-text" id="progressText">0%</span>
                </div>
            </div>
            <p id="currentStep" class="current-step">Starting...</p>
        </div>
    </div>

    <script>
        // API Gateway URL - will be replaced after deployment
        const API_URL = '{{API_URL}}';

        const form = document.getElementById('uploadForm');
        const jsonFileInput = document.getElementById('jsonFile');
        const urlInput = document.getElementById('url');
        const emailInput = document.getElementById('email');
        const submitBtn = document.getElementById('submitBtn');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const loadingMessage = document.getElementById('loadingMessage');
        const successTitle = document.getElementById('successTitle');
        const successText = document.getElementById('successText');
        const errorText = document.getElementById('errorText');
        const fileInfo = document.getElementById('fileInfo');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const currentStep = document.getElementById('currentStep');

        // Show file info when file is selected
        jsonFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                fileInfo.textContent = `Selected: ${file.name} (${sizeInMB} MB)`;
            } else {
                fileInfo.textContent = '';
            }
        });

        // Poll job status until completion
        async function pollJobStatus(jobId, filename) {
            const maxAttempts = 120; // Poll for up to 6 minutes (120 * 3 seconds)
            let attempts = 0;

            while (attempts < maxAttempts) {
                try {
                    const statusResponse = await fetch(`${API_URL}status/${jobId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    // Handle 404 as "job not created yet" (race condition)
                    if (statusResponse.status === 404) {
                        console.log('Job not found yet, waiting...');
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        attempts++;
                        continue;
                    }

                    if (!statusResponse.ok) {
                        throw new Error('Failed to get job status');
                    }

                    const status = await statusResponse.json();
                    console.log('Job status:', status);

                    // Update progress bar and current step
                    const progress = status.progress_percentage || 0;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${progress}%`;
                    currentStep.textContent = status.current_step || 'Processing...';

                    if (status.status === 'completed') {
                        // Success!
                        loadingMessage.classList.add('hidden');
                        successTitle.textContent = 'Success!';
                        successText.textContent = `File: ${status.filename} - Dispatched ${status.controls_dispatched} controls for processing. You will receive an email notification when processing is complete.`;
                        successMessage.classList.remove('hidden');

                        // Reset form
                        form.reset();
                        fileInfo.textContent = '';
                        submitBtn.disabled = false;
                        return;
                    } else if (status.status === 'failed') {
                        // Failed
                        throw new Error(status.error || 'Processing failed');
                    }

                    // Still processing, wait and try again
                    await new Promise(resolve => setTimeout(resolve, 3000)); // Wait 3 seconds
                    attempts++;

                } catch (error) {
                    console.error('Error polling status:', error);
                    loadingMessage.classList.add('hidden');
                    errorText.textContent = error.message;
                    errorMessage.classList.remove('hidden');
                    submitBtn.disabled = false;
                    return;
                }
            }

            // Timeout
            loadingMessage.classList.add('hidden');
            errorText.textContent = 'Processing timeout. Please check status later.';
            errorMessage.classList.remove('hidden');
            submitBtn.disabled = false;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Hide previous messages
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            submitBtn.disabled = true;

            try {
                const file = jsonFileInput.files[0];
                if (!file) {
                    throw new Error('Please select a JSON file');
                }

                const url = urlInput.value.trim();
                const email = emailInput.value.trim();

                if (!email) {
                    throw new Error('Please enter an email address');
                }

                // Step 1: Get presigned upload URL
                console.log('Getting presigned URL...');
                const uploadUrlResponse = await fetch(`${API_URL}upload-url`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: file.name
                    })
                });

                if (!uploadUrlResponse.ok) {
                    throw new Error('Failed to get upload URL');
                }

                const uploadData = await uploadUrlResponse.json();
                console.log('Got presigned URL');

                // Store the S3 key for later use
                const s3Key = uploadData.key;

                // Step 2: Upload file directly to S3
                console.log('Uploading to S3...');
                const formData = new FormData();

                // Add all fields from presigned post
                Object.keys(uploadData.fields).forEach(key => {
                    formData.append(key, uploadData.fields[key]);
                });

                // Add file last
                formData.append('file', file);

                const s3Response = await fetch(uploadData.uploadUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!s3Response.ok) {
                    throw new Error('Failed to upload file to S3');
                }
                console.log('File uploaded to S3');

                // Step 3: Generate job ID and start Step Functions workflow
                // Generate job ID on frontend so we can poll immediately
                const jobId = crypto.randomUUID();
                console.log('Generated job ID:', jobId);

                console.log('Starting workflow...');
                const submitResponse = await fetch(`${API_URL}start-workflow`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        job_id: jobId,
                        filename: file.name,
                        url: url,
                        s3_key: s3Key,
                        email: email
                    })
                });

                if (!submitResponse.ok) {
                    throw new Error('Failed to start workflow');
                }

                const result = await submitResponse.json();
                console.log('Workflow started successfully', result);

                console.log('Polling for job status:', jobId);

                // Poll for job completion
                await pollJobStatus(jobId, file.name);

            } catch (error) {
                console.error('Error:', error);
                loadingMessage.classList.add('hidden');
                errorText.textContent = error.message;
                errorMessage.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
